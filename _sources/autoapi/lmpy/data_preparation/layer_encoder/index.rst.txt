:py:mod:`lmpy.data_preparation.layer_encoder`
=============================================

.. py:module:: lmpy.data_preparation.layer_encoder

.. autoapi-nested-parse::

   This module contains a class for encoding spatial layers into a Matrix.

   The 'LayerEncoder' class uses a grid to generate a base matrix structure
   and then each layer is encoded as a new column (or columns) for the resulting
   encoded matrix.

   .. todo::

      Consider if we want to support hexagonal cells, if so, we will need to
          mask the resulting data windows and possibly change the minimum
          coverage calculation.

   .. note:: Data array is oriented at top left (min x, max y)



Module Contents
---------------

Classes
~~~~~~~

.. autoapisummary::

   lmpy.data_preparation.layer_encoder.LayerEncoder




.. py:class:: LayerEncoder(grid_filename)

   Constructor for the layer encoder.

   :param grid_filename: A file path for the grid.
   :type grid_filename: str

   .. py:method:: _encode_layer(self, window_func, encode_func, column_name, num_columns=1)

      Encodes the layer using the provided encoding function.

      :param window_func: A function that returns a window of array data for a
                          provided x, y pair.
      :param encode_func: A function that encodes a window of array data.
      :param column_name: The header name to use for the column in the encoded
                          matrix.
      :param num_columns: The number of columns that will be encoded by
                          'encode_func'.  This can be non-zero if we are testing for
                          multiple biogeographic hypotheses in a single vector layer for
                          example.

      :returns: A list of column headers for the newly encoded columns.
      :rtype: list


   .. py:method:: _get_window_function(data, layer_bbox, cell_size, num_cell_sides=4)
      :staticmethod:

      Gets a windowing function for the data.

      This function generates a function that will return a "window" of array
      data for a given (x, y) pair.

      :param data: A numpy array with data for a layer
      :type data: np.ndarray
      :param layer_bbox: The bounding box of the layer in the map units of the
                         layer.
      :type layer_bbox: tuple
      :param cell_size: Either a single value or a tuple with two
                        values. If it is a single value, it will be used for both x and y cell
                        sizes. If a tuple is provided, the first value will be used for the
                        size of each cell in the x dimension and the second will be used for
                        the size of the cell in the y dimension.
      :type cell_size: float or tuple
      :param num_cell_sides:
                             The number of sides each grid cell has::
                                 4 -- square
                                 6 -- hexagon
      :type num_cell_sides: int

      .. note::

         The origin (0, 0) of the data array should represent (min x, max y)
             for the layer.

      :raises NotImplementedError: Raised if cell sides does note equal 4.

      :returns: A function for processing a window of data.
      :rtype: Method

      .. todo:: CJ - Enable hexagonal windows by masking data.


   .. py:method:: _read_grid(self, grid_filename)

      Read the grid.

      :param grid_filename: The file location of the grid.


   .. py:method:: _read_layer(self, layer_filename, resolution=None, bbox=None, nodata=DEFAULT_NODATA, attribute_field=None)

      Reads a layer for processing.

      :param layer_filename: The file path for the layer to read.
      :type layer_filename: str
      :param resolution: An optional resolution to use for the input data if
                         it is a vector layer.
      :type resolution: numeric
      :param bbox: An optional bounding box in the form
                   (min x, min y, max x, max y) to use if the layer is a vector layer.
      :type bbox: tuple
      :param nodata: An optional nodata value to use if the layer is a vector
                     layer.
      :type nodata: numeric
      :param attribute_field: If provided, use this shapefile attribute as the data
                              value for a vector layer.
      :type attribute_field: str

      :returns:

                A tuple containing a window function for returning a portion of the
                    numpy array generated by the layer and the NODATA value to use with
                    this layer.
      :rtype: tuple


   .. py:method:: _read_raster_layer(self, raster_filename)

      Reads a raster layer for processing.

      :param raster_filename: The file path for the raster layer.

      :returns:

                A tuple containing a window function for returning a portion of the
                    numpy array generated by the layer and the NODATA value to use with
                    this layer.
      :rtype: tuple


   .. py:method:: _read_vector_layer(self, vector_filename, resolution=None, bbox=None, nodata=DEFAULT_NODATA, attribute_field=None)

      Reads a vector layer for processing.

      :param vector_filename: The vector file path for the layer to read.
      :param resolution: An optional resolution to use for the input data if
                         it is a vector layer.
      :type resolution: numeric
      :param bbox: An optional bounding box in the form
                   (min x, min y, max x, max y) to use if the layer is a vector layer.
      :type bbox: tuple
      :param nodata: An optional nodata value to use if the layer is a vector
                     layer.
      :type nodata: numeric
      :param attribute_field: If provided, use this shapefile attribute as the
                              data value for a vector layer.
      :type attribute_field: str

      :returns:

                A tuple containing a window function for returning a portion of the
                    numpy array generated by the layer, the NODATA value to use with this
                    layer, and a set of distinct attributes to be used for processing.
      :rtype: tuple


   .. py:method:: encode_biogeographic_hypothesis(self, layer_filename, column_name, min_coverage, resolution=None, bbox=None, nodata=DEFAULT_NODATA, attribute_field=None)

      Encodes a biogeographic hypothesis layer.

      Encodes a biogeographic hypothesis layer by creating a Helmert contrast
      column in the encoded matrix.

      :param layer_filename: The file location of the layer to encode.
      :param column_name: What to name this column in the encoded matrix.
      :param min_coverage: The minimum percentage of each data window that must
                           be covered.
      :param resolution: If the layer is a vector, optionally use this as the
                         resolution of the data grid.
      :param bbox: If the layer is a vector, optionally use this bounding box
                   for the data grid.
      :param nodata: If the layer is a vector, optionally use this as the data
                     grid nodata value.
      :param attribute_field: If the layer is a vector and contains multiple
                              hypotheses, use this field to separate the vector file.

      :returns: A list of column headers for the newly encoded columns.
      :rtype: list of str


   .. py:method:: encode_largest_class(self, layer_filename, column_name, min_coverage, resolution=None, bbox=None, nodata=DEFAULT_NODATA, attribute_name=None)

      Encodes a layer based on the largest class in each data window.

      :param layer_filename: The file location of the layer to encode.
      :param column_name: What to name this column in the encoded matrix.
      :param min_coverage: The minimum percentage of each data window that must
                           be the covered by the largest class.
      :param resolution: If the layer is a vector, optionally use this as the
                         resolution of the data grid.
      :param bbox: If the layer is a vector, optionally use this bounding box
                   for the data grid.
      :param nodata: If the layer is a vector, optionally use this as the data
                     grid nodata value.
      :param attribute_name: If the layer is a vector, use this field to
                             determine the largest class.

      :returns: A list of column headers for the newly encoded columns.
      :rtype: list of str


   .. py:method:: encode_mean_value(self, layer_filename, column_name, resolution=None, bbox=None, nodata=DEFAULT_NODATA, attribute_name=None)

      Encodes a layer based on the mean value for each data window.

      :param layer_filename: The file location of the layer to encode.
      :param column_name: What to name this column in the encoded matrix.
      :param resolution: If the layer is a vector, optionally use this as the
                         resolution of the data grid.
      :param bbox: If the layer is a vector, optionally use this bounding box
                   for the data grid.
      :param nodata: If the layer is a vector, optionally use this as the data
                     grid nodata value.
      :param attribute_name: If the layer is a vector, use this field to
                             determine value.

      :returns: A list of column headers for the newly encoded columns
      :rtype: list of str


   .. py:method:: encode_presence_absence(self, layer_filename, column_name, min_presence, max_presence, min_coverage, resolution=None, bbox=None, nodata=DEFAULT_NODATA, attribute_name=None)

      Encodes a distribution layer into a presence absence column.

      :param layer_filename: The file location of the layer to encode.
      :param column_name: What to name this column in the encoded matrix.
      :param min_presence: The minimum value that should be treated as presence.
      :param max_presence: The maximum value to be considered as present.
      :param min_coverage: The minimum percentage of each data window that must
                           be present to consider that cell present.
      :param resolution: If the layer is a vector, optionally use this as the
                         resolution of the data grid.
      :param bbox: If the layer is a vector, optionally use this bounding box
                   for the data grid.
      :param nodata: If the layer is a vector, optionally use this as the data
                     grid nodata value.
      :param attribute_name: If the layer is a vector, use this field to
                             determine presence.

      :returns: A list of column headers for the newly encoded columns.
      :rtype: list of str


   .. py:method:: get_encoded_matrix(self)

      Returns the encoded matrix.

      :returns: The encoded matrix as a Matrix object
      :rtype: Matrix


   .. py:method:: get_geojson(self)

      Formats the encoded matrix as GeoJSON.

      :returns: A JSON dictionary for the encoded matrix.
      :rtype: dict



